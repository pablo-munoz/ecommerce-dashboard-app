<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>E-commerce Analytics Dashboard</title>

  <!-- Plotly -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.26.0/plotly.min.js"></script>

  <style>
    /* ------- CSS Variables for Theming ------- */
    :root {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-card: #1e293b;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --accent-primary: #3b82f6;
      --accent-secondary: #8b5cf6;
      --accent-success: #10b981;
      --accent-warning: #f59e0b;
      --border-color: #334155;
      --shadow: rgba(0, 0, 0, 0.3);
    }

    .light-theme {
      --bg-primary: #f8fafc;
      --bg-secondary: #ffffff;
      --bg-card: #ffffff;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --accent-primary: #3b82f6;
      --accent-secondary: #8b5cf6;
      --accent-success: #10b981;
      --accent-warning: #f59e0b;
      --border-color: #e2e8f0;
      --shadow: rgba(0, 0, 0, 0.1);
    }

    /* ------- Base / Layout ------- */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      padding: 20px;
      transition: all 0.3s ease;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ------- Header ------- */
    header {
      background: var(--bg-card);
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px var(--shadow);
      margin-bottom: 30px;
      border: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
    }

    .header-left {
      flex: 1;
    }

    .header-right {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    h1 {
      color: var(--text-primary);
      font-size: 2.2em;
      margin-bottom: 6px;
      font-weight: 700;
    }

    .subtitle {
      color: var(--text-secondary);
      font-size: 0.95em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .badge {
      display: inline-block;
      padding: 4px 12px;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      color: white;
      border-radius: 20px;
      font-size: 0.75em;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    /* ------- Icon Buttons ------- */
    .icon-btn {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      border: 1px solid var(--border-color);
      background: var(--bg-card);
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2em;
    }

    .icon-btn:hover {
      background: var(--accent-primary);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px var(--shadow);
    }

    /* ------- Filters ------- */
    .filters {
      background: var(--bg-card);
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 5px 15px var(--shadow);
      margin-bottom: 24px;
      border: 1px solid var(--border-color);
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
      animation: slideDown 0.4s ease;
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .filter-group label {
      color: var(--text-secondary);
      font-size: 0.85em;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    select, button, input[type="date"] {
      padding: 12px 16px;
      border: 1px solid var(--border-color);
      border-radius: 10px;
      font-size: 0.95em;
      cursor: pointer;
      transition: all 0.2s ease;
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    select:hover, input[type="date"]:hover {
      border-color: var(--accent-primary);
    }

    select:focus, input[type="date"]:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    button {
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      color: white;
      font-weight: 600;
      border: none;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px var(--shadow);
    }

    .button-secondary {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }

    .button-secondary:hover {
      background: var(--accent-primary);
      color: white;
      border-color: var(--accent-primary);
    }

    .filter-hint {
      color: var(--text-secondary);
      font-size: 0.9em;
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      background: var(--bg-secondary);
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    /* ------- KPIs ------- */
    .kpi-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .kpi-card {
      background: var(--bg-card);
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 5px 15px var(--shadow);
      border: 1px solid var(--border-color);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .kpi-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: linear-gradient(180deg, var(--accent-primary), var(--accent-secondary));
    }

    .kpi-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px var(--shadow);
    }

    .kpi-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .kpi-label {
      color: var(--text-secondary);
      font-size: 0.85em;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 600;
    }

    .kpi-icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2em;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      color: white;
    }

    .kpi-value {
      color: var(--text-primary);
      font-size: 2.4em;
      font-weight: 800;
      margin-bottom: 8px;
    }

    .kpi-trend {
      font-size: 0.85em;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .trend-up { color: var(--accent-success); }
    .trend-down { color: var(--accent-warning); }

    /* ------- Charts ------- */
    .chart-container {
      background: var(--bg-card);
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 5px 15px var(--shadow);
      margin-bottom: 24px;
      border: 1px solid var(--border-color);
      position: relative;
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 2px solid var(--border-color);
    }

    .chart-title {
      color: var(--text-primary);
      font-size: 1.25em;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .chart-actions {
      display: flex;
      gap: 8px;
    }

    .chart-btn {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background: var(--bg-secondary);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9em;
    }

    .chart-btn:hover {
      background: var(--accent-primary);
      color: white;
      border-color: var(--accent-primary);
    }

    .grid-2 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(520px, 1fr));
      gap: 24px;
    }

    .grid-3 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
      gap: 24px;
    }

    /* ------- Loading ------- */
    .loading {
      text-align: center;
      color: var(--text-primary);
      font-size: 1.2em;
      padding: 40px;
    }

    .spinner {
      border: 4px solid var(--border-color);
      border-top: 4px solid var(--accent-primary);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ------- Responsive ------- */
    @media (max-width: 768px) {
      h1 { font-size: 1.6em; }
      .grid-2, .grid-3 {
        grid-template-columns: 1fr;
      }
      header {
        flex-direction: column;
        align-items: flex-start;
      }
      .header-right {
        width: 100%;
        justify-content: flex-end;
      }
    }

    /* ------- Tooltips ------- */
    .tooltip {
      position: relative;
      display: inline-block;
      cursor: help;
    }

    .tooltip .tooltiptext {
      visibility: hidden;
      width: 200px;
      background-color: var(--bg-secondary);
      color: var(--text-primary);
      text-align: center;
      border-radius: 8px;
      padding: 8px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -100px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 0.85em;
      border: 1px solid var(--border-color);
      box-shadow: 0 5px 15px var(--shadow);
    }

    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
  </style>
</head>

<body>
<div class="container">

  <header>
    <div class="header-left">
      <h1>üìä E-commerce Analytics Dashboard</h1>
      <div class="subtitle">
        <span class="badge">LIVE</span>
        <span>Cloud-Native Data Pipeline ¬∑ AWS S3 ¬∑ Glue ¬∑ Athena</span>
      </div>
    </div>
    <div class="header-right">
      <button class="icon-btn tooltip" id="exportBtn" title="Export Data">
        üì•
        <span class="tooltiptext">Export dashboard data</span>
      </button>
      <button class="icon-btn tooltip" id="themeToggle" title="Toggle Theme">
        üåì
        <span class="tooltiptext">Switch theme</span>
      </button>
      <button class="icon-btn tooltip" id="helpBtn" title="Help">
        ‚ùì
        <span class="tooltiptext">Dashboard help</span>
      </button>
    </div>
  </header>

  <!-- Filters -->
  <div class="filters">
    <div class="filter-group">
      <label>Country</label>
      <select id="countryFilter">
        <option value="all">All Countries</option>
      </select>
    </div>

    <div class="filter-group">
      <label>Date Range</label>
      <select id="dateRangeFilter">
        <option value="all">All Time</option>
        <option value="30">Last 30 Days</option>
        <option value="90">Last Quarter</option>
        <option value="365">Last Year</option>
      </select>
    </div>

    <div style="display: flex; gap: 8px; align-items: flex-end;">
      <button id="applyBtn" type="button">
        <span>üîç</span> Apply Filters
      </button>
      <button id="refreshBtn" type="button" class="button-secondary">
        <span>üîÑ</span> Refresh
      </button>
      <button id="resetBtn" type="button" class="button-secondary">
        <span>‚Ü∫</span> Reset
      </button>
    </div>

    <div class="filter-hint" id="filterHint">
      <span>‚ÑπÔ∏è</span>
      <span id="filterHintText">Showing all countries</span>
    </div>
  </div>

  <!-- KPIs -->
  <div class="kpi-container">
    <div class="kpi-card">
      <div class="kpi-header">
        <div class="kpi-label">Total Revenue</div>
        <div class="kpi-icon">üí∞</div>
      </div>
      <div class="kpi-value" id="kpiRevenue">‚Äî</div>
      <div class="kpi-trend trend-up">
        <span>‚Üë</span> <span>vs. last period</span>
      </div>
    </div>

    <div class="kpi-card">
      <div class="kpi-header">
        <div class="kpi-label">Total Orders</div>
        <div class="kpi-icon">üõí</div>
      </div>
      <div class="kpi-value" id="kpiOrders">‚Äî</div>
      <div class="kpi-trend trend-up">
        <span>‚Üë</span> <span>vs. last period</span>
      </div>
    </div>

    <div class="kpi-card">
      <div class="kpi-header">
        <div class="kpi-label">Unique Customers</div>
        <div class="kpi-icon">üë•</div>
      </div>
      <div class="kpi-value" id="kpiCustomers">‚Äî</div>
      <div class="kpi-trend trend-up">
        <span>‚Üë</span> <span>vs. last period</span>
      </div>
    </div>

    <div class="kpi-card">
      <div class="kpi-header">
        <div class="kpi-label">Avg Order Value</div>
        <div class="kpi-icon">üìà</div>
      </div>
      <div class="kpi-value" id="kpiAOV">‚Äî</div>
      <div class="kpi-trend trend-down">
        <span>‚Üì</span> <span>vs. last period</span>
      </div>
    </div>
  </div>

  <!-- Row 1 -->
  <div class="grid-2">
    <div class="chart-container">
      <div class="chart-header">
        <div class="chart-title">üìä Monthly Revenue Trend</div>
        <div class="chart-actions">
          <button class="chart-btn tooltip" title="Download">
            üíæ
          </button>
          <button class="chart-btn tooltip" title="Fullscreen">
            ‚õ∂
          </button>
        </div>
      </div>
      <div id="revenueChart"></div>
    </div>

    <div class="chart-container">
      <div class="chart-header">
        <div class="chart-title">üèÜ Top 15 Products by Revenue</div>
        <div class="chart-actions">
          <button class="chart-btn tooltip" title="Download">
            üíæ
          </button>
          <button class="chart-btn tooltip" title="Fullscreen">
            ‚õ∂
          </button>
        </div>
      </div>
      <div id="productsChart"></div>
    </div>
  </div>

  <!-- Row 2 -->
  <div class="grid-2">
    <div class="chart-container">
      <div class="chart-header">
        <div class="chart-title">üéØ RFM Customer Segmentation</div>
        <div class="chart-actions">
          <button class="chart-btn tooltip" title="Download">
            üíæ
          </button>
          <button class="chart-btn tooltip" title="Info">
            ‚ÑπÔ∏è
          </button>
        </div>
      </div>
      <div id="rfmChart"></div>
    </div>

    <div class="chart-container">
      <div class="chart-header">
        <div class="chart-title">üåç Revenue by Country</div>
        <div class="chart-actions">
          <button class="chart-btn tooltip" title="Download">
            üíæ
          </button>
        </div>
      </div>
      <div id="countryPieChart"></div>
    </div>
  </div>

  <!-- Row 3 -->
  <div class="grid-2">
    <div class="chart-container">
      <div class="chart-header">
        <div class="chart-title">üó∫Ô∏è Geographic Revenue Distribution</div>
        <div class="chart-actions">
          <button class="chart-btn tooltip" title="Download">
            üíæ
          </button>
        </div>
      </div>
      <div id="geoChart"></div>
    </div>

    <div class="chart-container">
      <div class="chart-header">
        <div class="chart-title">üìÖ Customer Retention by Cohort</div>
        <div class="chart-actions">
          <button class="chart-btn tooltip" title="Download">
            üíæ
          </button>
          <button class="chart-btn tooltip" title="Info">
            ‚ÑπÔ∏è
          </button>
        </div>
      </div>
      <div id="cohortChart"></div>
    </div>
  </div>

</div>

<script>
let dashboardData = null;
let currentCountry = 'all';

/* ISO-3 MAP */
const ISO3_MAP = {
  'United Kingdom': 'GBR', 'UK': 'GBR', 'Great Britain': 'GBR', 'England': 'GBR', 'Scotland': 'GBR', 'Wales': 'GBR',
  'France': 'FRA', 'Spain': 'ESP', 'Portugal': 'PRT', 'Italy': 'ITA', 'Germany': 'DEU', 'Netherlands': 'NLD',
  'Norway': 'NOR', 'Sweden': 'SWE', 'Denmark': 'DNK', 'Finland': 'FIN', 'Ireland': 'IRL', 'EIRE': 'IRL',
  'Poland': 'POL', 'Czech Republic': 'CZE', 'Czechia': 'CZE', 'Austria': 'AUT', 'Switzerland': 'CHE',
  'Belgium': 'BEL', 'Greece': 'GRC', 'Romania': 'ROU', 'Bulgaria': 'BGR', 'Croatia': 'HRV', 'Slovenia': 'SVN',
  'Australia': 'AUS', 'United States': 'USA', 'USA': 'USA', 'Canada': 'CAN', 'Mexico': 'MEX',
  'Brazil': 'BRA', 'Argentina': 'ARG', 'Chile': 'CHL', 'Peru': 'PER', 'Colombia': 'COL'
};

/* Event Listeners */
document.getElementById('applyBtn').addEventListener('click', () => {
  currentCountry = document.getElementById('countryFilter').value;
  renderDashboard();
});

document.getElementById('refreshBtn').addEventListener('click', () => location.reload());

document.getElementById('resetBtn').addEventListener('click', () => {
  document.getElementById('countryFilter').value = 'all';
  document.getElementById('dateRangeFilter').value = 'all';
  currentCountry = 'all';
  renderDashboard();
});

document.getElementById('themeToggle').addEventListener('click', () => {
  document.body.classList.toggle('light-theme');
  localStorage.setItem('theme', document.body.classList.contains('light-theme') ? 'light' : 'dark');
});

document.getElementById('exportBtn').addEventListener('click', () => {
  alert('Export functionality would download the current filtered data as CSV/PDF');
});

document.getElementById('helpBtn').addEventListener('click', () => {
  alert('Dashboard Help:\n\n- Use filters to segment data by country\n- Hover over charts for detailed information\n- Click chart actions to download or fullscreen\n- Toggle theme with the moon icon');
});

// Load theme preference
if (localStorage.getItem('theme') === 'light') {
  document.body.classList.add('light-theme');
}

loadData();

/* Load JSON */
async function loadData() {
  try {
    const res = await fetch('data/dashboard-data.json');
    dashboardData = await res.json();
    populateFilters();
    renderDashboard();
  } catch (err) {
    console.error('Error loading data:', err);
    document.body.insertAdjacentHTML(
      'beforeend',
      '<div class="loading"><div class="spinner"></div>Failed to load dashboard-data.json ‚Äî please ensure it exists under /data.</div>'
    );
  }
}

function populateFilters() {
  const select = document.getElementById('countryFilter');
  const countries = Array.from(
    new Set((dashboardData?.country_revenue || []).map(d => d.country).filter(Boolean))
  ).sort();
  countries.forEach(country => {
    const opt = document.createElement('option');
    opt.value = country;
    opt.textContent = country;
    select.appendChild(opt);
  });
}

/* Render */
function renderDashboard() {
  const hint = document.getElementById('filterHintText');
  hint.textContent = currentCountry === 'all'
    ? 'Showing all countries'
    : `Filtered to: ${currentCountry}`;

  renderKPIs();
  renderMonthlyTrend();
  renderTopProducts();
  renderRFM();
  renderCountryPie();
  renderGeo();
  renderCohort();
}

/* KPIs */
function renderKPIs() {
  const rows = currentCountry === 'all'
      ? (dashboardData?.country_revenue || [])
      : (dashboardData?.country_revenue || []).filter(d => (d.country || '').trim() === currentCountry);

  const providedKPIs = (dashboardData?.kpis && dashboardData.kpis[0] && currentCountry === 'all')
      ? dashboardData.kpis[0]
      : null;

  const getField = (obj, alts, fallback = 0) => {
    if (!obj) return fallback;
    for (const k of alts) {
      for (const key of [k, k.toLowerCase(), k.toUpperCase()]) {
        if (Object.prototype.hasOwnProperty.call(obj, key) && obj[key] != null) {
          const v = obj[key];
          const n = (typeof v === 'string') ? Number(v.replace(/[, ]/g,'')) : Number(v);
          return Number.isFinite(n) ? n : v;
        }
      }
    }
    return fallback;
  };

  const ORDER_KEYS = ['orders','total_orders','order_count','orders_count','monthly_orders','num_orders'];
  const CUSTOMER_KEYS = ['customers','unique_customers','customer_count','customers_count','num_customers'];
  const REVENUE_KEYS = ['revenue','total_revenue'];
  const AOV_KEYS = ['avg_order_value','aov','average_order_value'];

  let totalRevenue = 0, totalOrders = 0, totalCustomers = 0, avgOrderValue = 0;

  if (providedKPIs) {
    totalRevenue = getField(providedKPIs, REVENUE_KEYS, 0) || 0;
    totalOrders = getField(providedKPIs, ORDER_KEYS, 0) || 0;
    totalCustomers = getField(providedKPIs, CUSTOMER_KEYS, 0) || 0;

    const aovFromKpis = getField(providedKPIs, AOV_KEYS, 0) || 0;
    avgOrderValue = aovFromKpis || (totalOrders ? (totalRevenue / totalOrders) : 0);
  } else {
    totalRevenue = rows.reduce((s, d) => s + (getField(d, REVENUE_KEYS, 0) || 0), 0);
    totalOrders = rows.reduce((s, d) => s + (getField(d, ORDER_KEYS, 0) || 0), 0);
    totalCustomers = rows.reduce((s, d) => s + (getField(d, CUSTOMER_KEYS, 0) || 0), 0);

    avgOrderValue = totalOrders > 0 ? (totalRevenue / totalOrders)
                                    : getField(rows[0] || {}, AOV_KEYS, 0) || 0;
  }

  document.getElementById('kpiRevenue').textContent = `$${(Number(totalRevenue) / 1e6).toFixed(2)}M`;
  document.getElementById('kpiOrders').textContent = Number(totalOrders || 0).toLocaleString();
  document.getElementById('kpiCustomers').textContent = Number(totalCustomers || 0).toLocaleString();
  document.getElementById('kpiAOV').textContent = `$${Number(avgOrderValue || 0).toFixed(2)}`;
}

/* Monthly Revenue Trend */
function renderMonthlyTrend() {
  let monthly = [];

  if (currentCountry === 'all') {
    monthly = (dashboardData?.monthly_sales && dashboardData.monthly_sales.length)
      ? dashboardData.monthly_sales.map(d => ({ x: d.sales_month, y: d.monthly_revenue }))
      : (dashboardData?.monthly_revenue || []).map(d => ({ x: d.month, y: d.revenue }));
  } else {
    const byCountry = dashboardData?.monthly_revenue_by_country || [];
    if (byCountry.length) {
      monthly = byCountry
        .filter(d => d.country === currentCountry)
        .map(d => ({ x: d.month, y: d.revenue }));
    } else if (dashboardData?.monthly_sales?.length) {
      monthly = dashboardData.monthly_sales.map(d => ({ x: d.sales_month, y: d.monthly_revenue }));
    } else if (dashboardData?.monthly_revenue?.length) {
      monthly = dashboardData.monthly_revenue.map(d => ({ x: d.month, y: d.revenue }));
    }
  }

  monthly.sort((a, b) => new Date(a.x) - new Date(b.x));

  const trace = {
    x: monthly.map(d => d.x),
    y: monthly.map(d => d.y),
    type: 'scatter',
    mode: 'lines+markers',
    line: { color: '#667eea', width: 3 },
    marker: { size: 8 },
    hovertemplate: '%{x}<br>$%{y:,.0f}<extra></extra>'
  };

  Plotly.newPlot('revenueChart', [trace], {
    xaxis: { title: 'Month' },
    yaxis: { title: 'Revenue ($)', tickformat: ',~s' },
    margin: { t: 10 },
    paper_bgcolor: 'rgba(0,0,0,0)',
    plot_bgcolor: 'rgba(0,0,0,0)'
  }, { responsive: true });
}

/* Top Products */
function renderTopProducts() {
  let products = dashboardData.top_products || [];

  if (currentCountry !== 'all') {
    products = products.filter(p => p.country === currentCountry);
  }

  products = products
    .sort((a, b) => b.revenue - a.revenue)
    .slice(0, 15)
    .reverse();

  const trace = {
    x: products.map(d => +d.revenue || 0),
    y: products.map(d => (d.description || '').slice(0, 40)),
    type: "bar",
    orientation: "h",
    marker: { color: "#764ba2" },
    hovertemplate: "%{y}<br>$%{x:,.0f}<extra></extra>"
  };

  Plotly.newPlot(
    "productsChart",
    [trace],
    {
      xaxis: { title: "Revenue ($)", tickformat: ",~s" },
      yaxis: { automargin: true },
      margin: { t: 10, l: 160 },
      paper_bgcolor: 'rgba(0,0,0,0)',
      plot_bgcolor: 'rgba(0,0,0,0)'
    }
  );
}

/* RFM Chart */
function renderRFM() {
  let rfm = dashboardData.rfm_analysis || [];

  if (currentCountry !== "all") {
    rfm = rfm.filter(d => d.country === currentCountry);
  }

  const trace = {
    x: rfm.map(d => +d.frequency || 0),
    y: rfm.map(d => +d.monetary || 0),
    mode: "markers",
    type: "scatter",
    marker: {
      size: rfm.map(d => Math.max(6, (+d.frequency || 0) / 2)),
      color: rfm.map(d => +d.recency || 0),
      colorscale: "Viridis",
      showscale: true,
      colorbar: { title: "Recency" }
    },
    text: rfm.map(
      d => `Customer: ${d.customerid}<br>Recency: ${d.recency} days<br>Frequency: ${d.frequency}<br>Monetary: $${(+d.monetary || 0).toFixed(2)}`
    ),
    hoverinfo: "text"
  };

  Plotly.newPlot(
    "rfmChart",
    [trace],
    {
      xaxis: { title: "Frequency" },
      yaxis: { title: "Monetary ($)", tickformat: ",~s" },
      margin: { t: 10 },
      paper_bgcolor: 'rgba(0,0,0,0)',
      plot_bgcolor: 'rgba(0,0,0,0)'
    }
  );
}

/* Country Pie */
function renderCountryPie() {
  let data = dashboardData.country_revenue || [];

  if (currentCountry !== "all") {
    data = data.filter(d => d.country === currentCountry);
  }

  const labels = data.map(d => d.country);
  const values = data.map(d => +d.revenue || 0);

  Plotly.newPlot(
    "countryPieChart",
    [{
      labels, values, type: "pie",
      marker: {
        colors: [
          "#667eea","#764ba2","#f093fb","#4facfe","#00f2fe",
          "#43e97b","#fa709a","#fee140","#30cfd0","#a8edea"
        ]
      },
      hovertemplate: "%{label}<br>$%{value:,.0f} (%{percent})<extra></extra>"
    }],
    { 
      margin: { t: 10 },
      paper_bgcolor: 'rgba(0,0,0,0)'
    }
  );
}

/* Geo Map */
function renderGeo() {
  const all = dashboardData?.country_revenue || [];
  const filtered = currentCountry === 'all' ? all : all.filter(d => d.country === currentCountry);

  const locations = [];
  const z = [];
  const text = [];

  filtered.forEach(d => {
    const iso3 = ISO3_MAP[d.country] || null;
    if (iso3) {
      locations.push(iso3);
      z.push(+d.revenue || 0);
      text.push(`${d.country}: $${(+d.revenue || 0).toLocaleString()}`);
    }
  });

  const trace = {
    type: 'choropleth',
    locations,
    z,
    text,
    colorscale: 'Viridis',
    marker: { line: { color: 'white', width: 0.3 } },
    hovertemplate: '%{text}<extra></extra>'
  };

  Plotly.newPlot(
    'geoChart',
    [trace],
    {
      geo: { scope: 'world', projection: { type: 'equirectangular' } },
      margin: { t: 10 },
      paper_bgcolor: 'rgba(0,0,0,0)'
    },
    { responsive: true }
  );
}

/* Cohort */
function renderCohort() {
  let cohort = dashboardData.cohort_analysis || [];

  if (currentCountry !== "all") {
    cohort = cohort.filter(c => c.country === currentCountry);
  }

  if (!cohort.length) {
    Plotly.newPlot("cohortChart", [], {
      annotations: [{ text: "No cohort data", showarrow: false }],
      paper_bgcolor: 'rgba(0,0,0,0)'
    });
    return;
  }

  const pivot = {};

  cohort.forEach(r => {
    if (!pivot[r.cohort_month]) pivot[r.cohort_month] = {};
    pivot[r.cohort_month][+r.month_index] = +r.active_customers || 0;
  });

  const cohortMonths = Object.keys(pivot).sort(
    (a, b) => new Date(a) - new Date(b)
  );

  const sizes = cohortMonths.map(m => pivot[m][0] || 0);
  const maxIndex = Math.max(...cohort.map(d => +d.month_index || 0));

  const z = cohortMonths.map((month, idx) => {
    const base = sizes[idx];
    return Array.from({ length: maxIndex + 1 }).map(
      (_, i) => base > 0 ? ((pivot[month][i] || 0) / base) * 100 : 0
    );
  });

  const xLabels = Array.from({ length: maxIndex + 1 }, (_, i) => i);
  const yLabels = cohortMonths;

  Plotly.newPlot(
    "cohortChart",
    [{
      z,
      x: xLabels,
      y: yLabels,
      type: "heatmap",
      colorscale: "Greens",
      hovertemplate: "Cohort %{y}<br>Month +%{x}: %{z:.1f}%<extra></extra>"
    }],
    {
      xaxis: { title: "Months Since First Purchase" },
      yaxis: { automargin: true },
      margin: { t: 10 },
      paper_bgcolor: 'rgba(0,0,0,0)',
      plot_bgcolor: 'rgba(0,0,0,0)'
    }
  );
}
</script>

</body>
</html>
